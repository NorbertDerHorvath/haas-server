<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Haas - Ladezeiten</title>
    <style>
        body { 
            font-family: sans-serif; 
            margin: 20px; 
            background-color: #E0FFFF; /* Halvány cián háttér */
        }
        h1, h2 { 
            color: #333; 
        }
        .logo-container {
            position: absolute;
            top: 20px;
            right: 20px;
        }
        .filter-section { 
            background-color: #f9f9f9; 
            padding: 15px; 
            border-radius: 5px; 
            margin-bottom: 20px; 
            /* ÚJ: Flexbox a vízszintes elrendezéshez */
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px; /* Térköz az elemek között */
        }
        .filter-section h2 {
            width: 100%; /* A "Filter" cím teljes szélességű */
            margin-bottom: 10px;
        }
        .filter-section label { 
            margin-right: 5px; /* Kisebb margó a címke és a mező között */
        }
        .filter-section input, .filter-section select, .filter-section button { 
            padding: 8px; 
            font-size: 14px; 
        }
        table { 
            border-collapse: collapse; 
            width: 100%; 
            margin-top: 20px; 
        }
        th, td { 
            border: 1px solid #ddd; 
            padding: 8px; 
            text-align: left; 
            vertical-align: middle;
        }
        th { 
            background-color: #f2f2f2; 
        }
        tr:nth-child(even) { 
            background-color: #f9f9f9; 
        }
        td input[type="text"] {
            width: 150px;
            padding: 5px;
        }
        td button {
            padding: 5px 10px;
            margin-left: 5px;
        }
        .saved {
            background-color: #90EE90 !important; /* Halványzöld */
        }

        /* Placeholder szöveg halványítása */
        ::placeholder { /* Chrome, Firefox, Opera, Safari 10.1+ */
            color: #aaa;
            opacity: 1; /* Firefox */
        }
        /* Félkövér szöveg, ha van tartalom */
        input[type="text"]:not(:placeholder-shown) {
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div class="logo-container">
        <svg width="150" height="37.5" viewBox="0 0 400 100" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <linearGradient id="iconGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#40E0D0;" />
                    <stop offset="100%" style="stop-color:#00A693;" />
                </linearGradient>
            </defs>
            <g transform="translate(5, 5)">
                <path d="M 15 8 L 15 82 L 75 8 L 75 82" stroke="url(#iconGradient)" stroke-width="16" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
            </g>
            <text x="120" y="68" font-family="Poppins, sans-serif" font-size="50" fill="#212529">
                <tspan font-weight="700">Norb</tspan>
                <tspan font-weight="300">App</tspan>
            </text>
        </svg>
    </div>

    <h1>Ladezeiten-Dashboard</h1>

    <div class="filter-section">
        <h2>Filter</h2>
        
        <label for="driverFilter">Fahrer:</label>
        <select id="driverFilter"></select>

        <label for="startDate">Von:</label>
        <input type="date" id="startDate">

        <label for="endDate">Bis:</label>
        <input type="date" id="endDate">
        
        <label for="addressSearch">Adresse:</label>
        <input type="text" id="addressSearch" placeholder="Adresse suchen...">

        <button id="filterButton">Filtern</button>
        <button id="resetButton">Filter zurücksetzen</button>
    </div>

    <h2>Abgeschlossene Ladevorgänge</h2>
    <table id="sessionsTable">
        <thead>
            <tr>
                <th>Fahrername</th>
                <th>Ankunft</th>
                <th>Abfahrt</th>
                <th>Ladezeit</th>
                <th>Adresse</th>
                <th>Kunde</th>
            </tr>
        </thead>
        <tbody id="sessionsTableBody"></tbody>
    </table>

    <script>
        const driverFilter = document.getElementById('driverFilter');
        const startDate = document.getElementById('startDate');
        const endDate = document.getElementById('endDate');
        const addressSearch = document.getElementById('addressSearch');
        const filterButton = document.getElementById('filterButton');
        const resetButton = document.getElementById('resetButton');
        const tableBody = document.getElementById('sessionsTableBody');

        async function populateDrivers() {
            try {
                const response = await fetch('/api/drivers');
                const drivers = await response.json();
                driverFilter.innerHTML = '<option value="">Alle Fahrer</option>';
                drivers.forEach(driver => {
                    if (!driver) return;
                    const option = document.createElement('option');
                    option.value = driver;
                    option.textContent = driver;
                    driverFilter.appendChild(option);
                });
            } catch (error) {
                console.error('Fehler beim Laden der Fahrerliste:', error);
            }
        }

        async function fetchWorkSessions() {
            tableBody.innerHTML = '<tr><td colspan="6">Lade Daten...</td></tr>';

            const driver = driverFilter.value;
            const start = startDate.value;
            const end = endDate.value;
            const address = addressSearch.value;

            let url = '/api/work-sessions?';
            if (driver) url += `driver=${encodeURIComponent(driver)}&`;
            if (start) url += `startDate=${start}&`;
            if (end) url += `endDate=${end}&`;
            if (address) url += `address=${encodeURIComponent(address)}&`;

            try {
                const response = await fetch(url);
                const sessions = await response.json();
                tableBody.innerHTML = '';

                if (sessions.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6">Keine abgeschlossenen Ladevorgänge für die ausgewählten Filter gefunden.</td></tr>';
                    return;
                }

                sessions.forEach(session => {
                    const row = document.createElement('tr');
                    
                    const arrivalTimestamp = parseInt(session.arrivalTime, 10);
                    const departureTimestamp = parseInt(session.departureTime, 10);

                    const arrivalDate = arrivalTimestamp ? new Date(arrivalTimestamp).toLocaleString('de-DE') : 'Ungültig';
                    const departureDate = departureTimestamp ? new Date(departureTimestamp).toLocaleString('de-DE') : 'Ungültig';

                    const googleMapsLink = session.address ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(session.address)}` : '#';
                    const addressDisplay = session.address ? `<a href="${googleMapsLink}" target="_blank">${session.address}</a>` : 'N/A';

                    const kundeCell = `
                        <input type="text" placeholder="Kunde eintragen..." data-session-id="${session.sessionId}" value="${session.customerName || ''}">
                        <button data-session-id="${session.sessionId}">Speichern</button>
                    `;

                    row.innerHTML = `
                        <td>${session.driverName || 'N/A'}</td>
                        <td>${arrivalDate}</td>
                        <td>${departureDate}</td>
                        <td>${session.duration || 'N/A'}</td>
                        <td>${addressDisplay}</td>
                        <td>${kundeCell}</td>
                    `;
                    tableBody.appendChild(row);
                });

            } catch (error) {
                tableBody.innerHTML = '<tr><td colspan="6">Fehler beim Laden.</td></tr>';
                console.error('Hiba az adatok lekérésekor:', error);
            }
        }

        tableBody.addEventListener('click', async function(event) {
            if (event.target.tagName === 'BUTTON') {
                const button = event.target;
                const sessionId = button.getAttribute('data-session-id');
                const input = tableBody.querySelector(`input[data-session-id="${sessionId}"]`);
                const customerName = input.value;

                button.textContent = 'Speichere...';
                button.disabled = true;

                try {
                    const response = await fetch('/api/customer', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ sessionId, customerName }),
                    });

                    if (response.ok) {
                        button.textContent = 'Gespeichert';
                        button.classList.add('saved');
                        if (input.value) {
                            input.style.fontWeight = 'bold';
                        } else {
                            input.style.fontWeight = 'normal';
                        }
                    } else {
                        throw new Error('Server-Fehler beim Speichern');
                    }
                } catch (error) {
                    console.error('Fehler beim Speichern des Kunden:', error);
                    alert('Speichern fehlgeschlagen!');
                    button.textContent = 'Speichern';
                    button.disabled = false;
                }
            }
        });

        function resetFilters() {
            driverFilter.value = '';
            startDate.value = '';
            endDate.value = '';
            addressSearch.value = '';
            fetchWorkSessions();
        }

        filterButton.addEventListener('click', fetchWorkSessions);
        resetButton.addEventListener('click', resetFilters);

        populateDrivers();
        fetchWorkSessions();
    </script>

</body>
</html>